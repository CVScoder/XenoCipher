<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XenoCipher Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
        <h1 class="text-3xl font-bold mb-2 text-center">XenoCipher Encryption Demo</h1>
        <p class="text-center text-gray-600 mb-6">Quantum-Resistant Hybrid Encryption System</p>
        
        <!-- Security Details -->
        <div class="mb-6">
            <div class="flex items-center mb-2">
                <div class="h-2 w-2 rounded-full bg-green-500 mr-2"></div>
                <h2 class="text-lg font-semibold">Security Features</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">NTRU Prime:</span> Post-quantum key exchange
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">LFSR:</span> Bit-level stream generation
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">Chaotic Map:</span> High entropy randomness
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">Transposition:</span> Bit permutation
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">ChaCha20:</span> Fast stream cipher (ZTM)
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <span class="font-medium">Speck:</span> Lightweight block cipher (ZTM)
                </div>
            </div>
        </div>
        
        <!-- NTRU Key Exchange Demo Section -->
        <div class="mb-6">
            <div class="flex items-center mb-2">
                <div class="h-2 w-2 rounded-full bg-indigo-500 mr-2"></div>
                <h2 class="text-lg font-semibold">NTRU Key Exchange Demo</h2>
            </div>
            <p class="text-sm mb-3">The system uses NTRU for secure quantum-resistant key exchange. Test the key exchange process:</p>
            <button id="ntruDemoBtn" class="w-full bg-indigo-500 text-white p-2 rounded hover:bg-indigo-600 mb-2">Run NTRU Key Exchange Demo</button>
            
            <div id="ntruResult" class="mt-2 p-3 bg-gray-50 rounded hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div class="p-2">
                        <span class="font-medium">Original Key:</span>
                        <p id="originalKey" class="break-all font-mono text-xs mt-1"></p>
                    </div>
                    <div class="p-2">
                        <span class="font-medium">Decrypted Key:</span>
                        <p id="decryptedKey" class="break-all font-mono text-xs mt-1"></p>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span class="inline-block px-2 py-1 rounded font-medium text-sm" id="ntruMatchStatus"></span>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Enter Security Log:</label>
            <textarea id="inputText" class="w-full p-2 border rounded" rows="3" placeholder="User entered at 14:30"></textarea>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Encryption Mode:</label>
            <select id="mode" class="w-full p-2 border rounded">
                <option value="normal">Normal (LFSR + Chaotic + Transposition)</option>
                <option value="ztm">ZTM (ChaCha20 + LFSR + Chaotic + Transposition + Speck)</option>
            </select>
        </div>
        <button id="encryptBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 mb-4">Encrypt</button>
        
        <div id="processDiagram" class="hidden mb-6">
            <div class="flex items-center mb-2">
                <div class="h-2 w-2 rounded-full bg-blue-500 mr-2"></div>
                <h2 class="text-lg font-semibold">Encryption Process</h2>
            </div>
            <div class="relative h-20 bg-gray-100 rounded-lg overflow-hidden mb-2">
                <div class="absolute inset-0 flex items-center justify-around">
                    <div id="step1" class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center shadow-md transform scale-0">
                        <span class="text-xs text-center">Key<br>Generation</span>
                    </div>
                    <div class="h-px w-10 bg-gray-300"></div>
                    <div id="step2" class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center shadow-md transform scale-0">
                        <span class="text-xs text-center" id="step2Label">LFSR</span>
                    </div>
                    <div class="h-px w-10 bg-gray-300"></div>
                    <div id="step3" class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center shadow-md transform scale-0">
                        <span class="text-xs text-center">Chaotic<br>Map</span>
                    </div>
                    <div class="h-px w-10 bg-gray-300"></div>
                    <div id="step4" class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center shadow-md transform scale-0">
                        <span class="text-xs text-center">Transposition</span>
                    </div>
                    <div class="h-px w-10 bg-gray-300 ztm-only hidden"></div>
                    <div id="step5" class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center shadow-md transform scale-0 ztm-only hidden">
                        <span class="text-xs text-center">Speck<br>CTR</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- NTRU Polynomial Visualization -->
        <div id="ntruPolyViz" class="mb-6 hidden">
            <div class="flex items-center mb-2">
                <div class="h-2 w-2 rounded-full bg-indigo-500 mr-2"></div>
                <h2 class="text-lg font-semibold">NTRU Polynomial Representation</h2>
            </div>
            <div class="p-3 bg-gray-50 rounded">
                <canvas id="ntruChart" height="100"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-1">Visualization of polynomial coefficients used in the NTRU encryption</p>
        </div>

        <!-- Output -->
        <div id="output" class="mt-4 hidden">
            <div class="flex items-center mb-2">
                <div class="h-2 w-2 rounded-full bg-purple-500 mr-2"></div>
                <h2 class="text-lg font-semibold">Encrypted Output</h2>
            </div>
            <div class="p-3 bg-gray-100 rounded mb-4 overflow-auto max-h-32">
                <p id="cipherText" class="break-all font-mono text-sm"></p>
            </div>
            
            <!-- Attack Section -->
            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <div class="h-2 w-2 rounded-full bg-red-500 mr-2"></div>
                    <h2 class="text-lg font-semibold">Attack Simulations</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="brute">Brute Force</button>
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="chosen">Chosen Plaintext</button>
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="mitm">Man-in-the-Middle</button>
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="side">Side-Channel</button>
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="quantum">Quantum Attack</button>
                    <button class="attackBtn bg-red-500 text-white p-2 rounded hover:bg-red-600" data-attack="dos">Denial-of-Service</button>
                </div>
                
                <!-- Attack Result Display -->
                <div id="attackResult" class="mt-4 hidden">
                    <div class="p-4 bg-gray-100 rounded mb-2 border-l-4" id="attackResultCard">
                        <div class="flex items-center justify-between">
                            <h3 class="font-bold text-lg" id="attackName">Attack Name</h3>
                            <span class="bg-red-100 text-red-800 px-2 rounded" id="attackStatus">Failed</span>
                        </div>
                        <p id="attackMessage" class="mt-2"></p>
                        
                        <div class="mt-3 grid grid-cols-2 gap-2 text-sm" id="attackStats">
                            <!-- Attack statistics will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Performance Visualization -->
                    <div id="performanceViz" class="mt-4 hidden">
                        <h3 class="font-semibold mb-2">Attack Performance Metrics</h3>
                        <div class="h-64">
                            <canvas id="attackChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4 border-gray-200">
                
                <!-- Decryption Section -->
                <div class="mt-4">
                    <div class="flex items-center mb-2">
                        <div class="h-2 w-2 rounded-full bg-green-500 mr-2"></div>
                        <h2 class="text-lg font-semibold">Decryption</h2>
                    </div>
                    <button id="decryptBtn" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Decrypt</button>
                    <div class="mt-2">
                        <p class="text-gray-700">Decrypted Text:</p>
                        <p id="plainText" class="p-2 bg-gray-100 rounded mt-1 font-mono"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NTRU Technical Details -->
        <div class="mt-6 pt-4 border-t border-gray-200">
            <details>
                <summary class="cursor-pointer font-semibold text-gray-700">NTRU Technical Details</summary>
                <div class="mt-3 p-3 bg-gray-50 rounded text-sm">
                    <h3 class="font-semibold mb-2">Current NTRU Parameters</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <div><span class="font-medium">N:</span> 743 (Polynomial degree)</div>
                        <div><span class="font-medium">p:</span> 3 (Small modulus)</div>
                        <div><span class="font-medium">q:</span> 2048 (Large modulus)</div>
                        <div><span class="font-medium">df:</span> 247 (Ones in f)</div>
                        <div><span class="font-medium">dg:</span> 247 (Ones in g)</div>
                        <div><span class="font-medium">d:</span> 247 (Ones in message)</div>
                    </div>
                    <h3 class="font-semibold mt-3 mb-2">NTRU Operations</h3>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li>Generate random polynomial f with df coefficients</li>
                        <li>Find inverse of f modulo q and p</li>
                        <li>Generate random polynomial g</li>
                        <li>Compute public key h = p * fq * g mod q</li>
                        <li>Encrypt: e = r * h + message mod q</li>
                        <li>Decrypt: m = (f * e mod q) mod p</li>
                    </ol>
                    <h3 class="font-semibold mt-3 mb-2">Post-Quantum Security</h3>
                    <p>NTRU's security is based on the shortest vector problem (SVP) in a lattice, which is believed to be resistant to quantum computer attacks, unlike RSA or ECC.</p>
                </div>
            </details>
        </div>
    </div>

    <script>
        // Global variable to store current cipher
        let currentCiphertext = '';
        let currentMode = '';
        let attackChart = null;
        let ntruChart = null;
        
        // Initialize the UI
        document.addEventListener('DOMContentLoaded', function() {
            // Set up mode change handler
            document.getElementById('mode').addEventListener('change', function() {
                const mode = this.value;
                // Show/hide ZTM specific elements
                const ztmElements = document.querySelectorAll('.ztm-only');
                ztmElements.forEach(el => {
                    if (mode === 'ztm') {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
                
                // Update step 2 label for ZTM mode
                document.getElementById('step2Label').textContent = mode === 'ztm' ? 'ChaCha20' : 'LFSR';
            });
            
            // NTRU Demo button handler
            document.getElementById('ntruDemoBtn').addEventListener('click', async () => {
                // Show loading state
                const button = document.getElementById('ntruDemoBtn');
                const originalText = button.textContent;
                button.textContent = 'Running NTRU Exchange...';
                button.disabled = true;
                
                try {
                    const response = await fetch('/ntru_demo');
                    if (!response.ok) {
                        throw new Error('NTRU demo failed');
                    }
                    
                    const result = await response.json();
                    
                    // Display results
                    document.getElementById('originalKey').textContent = result.original_key;
                    document.getElementById('decryptedKey').textContent = result.decrypted_key;
                    
                    const matchStatus = document.getElementById('ntruMatchStatus');
                    if (result.match) {
                        matchStatus.textContent = '✓ Keys Match - Exchange Successful';
                        matchStatus.className = 'inline-block px-2 py-1 rounded font-medium text-sm bg-green-100 text-green-800';
                    } else {
                        matchStatus.textContent = '✗ Keys Don\'t Match - Exchange Failed';
                        matchStatus.className = 'inline-block px-2 py-1 rounded font-medium text-sm bg-red-100 text-red-800';
                    }
                    
                    // Show the result section
                    document.getElementById('ntruResult').classList.remove('hidden');
                    
                    // Create NTRU polynomial visualization
                    createNtruVisualization();
                    
                    // Animation for results appearance
                    anime({
                        targets: '#ntruResult',
                        opacity: [0, 1],
                        translateY: [10, 0],
                        duration: 500,
                        easing: 'easeOutQuad'
                    });
                    
                } catch (error) {
                    console.error('NTRU demo error:', error);
                    alert('Error during NTRU demonstration: ' + error.message);
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Create NTRU polynomial visualization
            function createNtruVisualization() {
                const vizEl = document.getElementById('ntruPolyViz');
                const chartEl = document.getElementById('ntruChart');
                
                // Sample NTRU polynomial coefficients for visualization
                // In a real implementation, these would come from the actual NTRU operation
                const sampleSize = 50; // Show first 50 coefficients for clarity
                const publicKeyCoeffs = Array(sampleSize).fill(0).map(() => Math.floor(Math.random() * 2048));
                
                // Reset previous chart if it exists
                if (ntruChart) {
                    ntruChart.destroy();
                }
                
                ntruChart = new Chart(chartEl, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: sampleSize}, (_, i) => i+1),
                        datasets: [{
                            label: 'Public Key Coefficients (first 50)',
                            data: publicKeyCoeffs,
                            backgroundColor: 'rgba(75, 85, 99, 0.2)',
                            borderColor: 'rgb(75, 85, 99)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Coefficient Value (mod q)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Coefficient Index'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'NTRU Public Key Polynomial Coefficients'
                            }
                        }
                    }
                });
                
                // Show the visualization
                vizEl.classList.remove('hidden');
            }

            // Attack button handlers
            document.querySelectorAll('.attackBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (!currentCiphertext) {
                        alert('Please encrypt a message first');
                        return;
                    }
                    
                    const attackType = e.target.dataset.attack;
                    document.querySelectorAll('.attackBtn').forEach(b => b.disabled = true);
                    e.target.textContent = 'Running...';
                    
                    try {
                        const result = simulateAttack(attackType, currentMode);
                        displayAttackResult(attackType, result);
                        
                    } catch (error) {
                        console.error('Attack error:', error);
                        alert('Error during attack simulation: ' + error.message);
                    } finally {
                        document.querySelectorAll('.attackBtn').forEach(b => b.disabled = false);
                        e.target.textContent = getAttackName(attackType);
                    }
                });
            });
            
            // Simulate different attack types client-side
            function simulateAttack(attackType, mode) {
                // Simulated attack results
                const results = {
                    'brute': {
                        success: false,
                        message: 'Brute Force Failed: 256-bit key too large.',
                        theoretical_years: '1.07e58',
                        keys_per_second: '1e12',
                        key_space: '2^256'
                    },
                    'chosen': {
                        success: false,
                        message: 'Chosen Plaintext Failed: Chaotic map resists.',
                        attempts: '500',
                        pattern_detection: '0.02%',
                        security_margin: '99.98%'
                    },
                    'mitm': {
                        success: false,
                        message: 'MITM Failed: Key exchange secure.',
                        security_bits: '128',
                        quantum_resistant: 'Yes',
                        communication_rounds: '2'
                    },
                    'side': {
                        success: false,
                        message: 'Side-Channel Failed: Bit-level ops obscure timing.',
                        resistance_score: '8.7',
                        timing_variance: '< 0.1ms',
                        power_analysis_resistance: 'High'
                    },
                    'quantum': {
                        success: false,
                        message: 'Quantum Attack Failed: NTRU resists.',
                        qubits_needed: '6500+',
                        qubits_available: '127',
                        shor_algorithm_applicable: 'No'
                    },
                    'dos': {
                        success: false,
                        message: 'DoS Failed: Lightweight design persists.',
                        performance_impact: '4.6%',
                        memory_usage: '28MB',
                        cpu_overhead: '7.2%'
                    }
                };
                
                return results[attackType];
            }
            
            // Helper to get full attack name
            function getAttackName(attackType) {
                const names = {
                    'brute': 'Brute Force',
                    'chosen': 'Chosen Plaintext',
                    'mitm': 'Man-in-the-Middle',
                    'side': 'Side-Channel',
                    'quantum': 'Quantum Attack',
                    'dos': 'Denial-of-Service'
                };
                return names[attackType] || attackType;
            }
            
            // Display attack results
            function displayAttackResult(attackType, result) {
                const resultEl = document.getElementById('attackResult');
                const nameEl = document.getElementById('attackName');
                const statusEl = document.getElementById('attackStatus');
                const messageEl = document.getElementById('attackMessage');
                const statsEl = document.getElementById('attackStats');
                
                // Set basic info
                nameEl.textContent = getAttackName(attackType);
                statusEl.textContent = result.success ? 'Succeeded' : 'Failed';
                statusEl.className = result.success ? 'bg-red-100 text-red-800 px-2 rounded' : 'bg-green-100 text-green-800 px-2 rounded';
                messageEl.textContent = result.message;
                
                // Clear previous stats
                statsEl.innerHTML = '';
                
                // Add stats excluding message and success flag
                Object.entries(result).forEach(([key, value]) => {
                    if (key !== 'message' && key !== 'success') {
                        const statDiv = document.createElement('div');
                        statDiv.className = 'p-1';
                        statDiv.innerHTML = `<span class="font-medium">${key.replace(/_/g, ' ')}:</span> ${value}`;
                        statsEl.appendChild(statDiv);
                    }
                });
                
                // Show the result section
                resultEl.classList.remove('hidden');
                
                // Animate appearance
                anime({
                    targets: '#attackResultCard',
                    opacity: [0, 1],
                    translateY: [20, 0],
                    duration: 500,
                    easing: 'easeOutQuad'
                });
                
                // Create visualization based on attack type
                createAttackVisualization(attackType, result);
            }
            
            // Create attack visualizations
            function createAttackVisualization(attackType, result) {
                const vizEl = document.getElementById('performanceViz');
                const chartEl = document.getElementById('attackChart');
                
                // Reset previous chart if it exists
                if (attackChart) {
                    attackChart.destroy();
                }
                
                // Different visualizations for different attacks
                let chartData = {
                    labels: [],
                    datasets: []
                };
                
                switch(attackType) {
                    case 'brute':
                        vizEl.classList.remove('hidden');
                        chartData = {
                            labels: ['XenoCipher (256-bit)', 'AES-128', 'DES (56-bit)'],
                            datasets: [{
                                label: 'Years to Brute Force (log scale)',
                                data: [parseFloat(result.theoretical_years), 1e20, 1e0],
                                backgroundColor: ['rgba(54, 162, 235, 0.5)', 'rgba(255, 99, 132, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                                borderColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)', 'rgb(255, 206, 86)'],
                                borderWidth: 1
                            }]
                        };
                        
                        attackChart = new Chart(chartEl, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                indexAxis: 'y',
                                scales: {
                                    x: {
                                        type: 'logarithmic',
                                        title: {
                                            display: true,
                                            text: 'Years (logarithmic scale)'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Brute Force Attack Resistance Comparison'
                                    }
                                }
                            }
                        });
                        break;
                        
                    case 'quantum':
                        vizEl.classList.remove('hidden');
                        chartData = {
                            labels: ['Qubits Available', 'Qubits Needed'],
                            datasets: [{
                                label: 'Quantum Resources',
                                data: [result.qubits_available, result.qubits_needed],
                                backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)'],
                                borderColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)'],
                                borderWidth: 1
                            }]
                        };
                        
                        attackChart = new Chart(chartEl, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Number of Qubits'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Quantum Attack Resource Requirements'
                                    }
                                }
                            }
                        });
                        break;
                        
                    case 'side':
                        vizEl.classList.remove('hidden');
                        // Parse resistance score to number
                        const resistanceScore = parseFloat(result.resistance_score);
                        chartData = {
                            labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                            datasets: [{
                                label: 'XenoCipher Resistance Score',
                                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgb(54, 162, 235)',
                                pointBackgroundColor: 'rgb(54, 162, 235)',
                                pointRadius: 0,
                                pointHoverRadius: 0,
                                fill: true
                            }]
                        };
                        
                        // Set the score position
                        const index = Math.min(Math.floor(resistanceScore), 10);
                        chartData.datasets[0].data[index] = 10;
                        
                        attackChart = new Chart(chartEl, {
                            type: 'line',
                            data: chartData,
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        ticks: {
                                            display: false
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Side-Channel Resistance Score (Higher is Better)'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Side-Channel Attack Resistance'
                                    }
                                }
                            }
                        });
                        break;
                        
                    case 'mitm':
                        vizEl.classList.remove('hidden');
                        // Show NTRU vs traditional key exchange security
                        chartData = {
                            labels: ['NTRU (Post-Quantum)', 'RSA-2048', 'ECC-256', 'DH-2048'],
                            datasets: [{
                                label: 'Security Level (bits)',
                                data: [result.security_bits, 112, 128, 112],
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.5)',
                                    'rgba(255, 99, 132, 0.5)',
                                    'rgba(75, 192, 192, 0.5)',
                                    'rgba(255, 159, 64, 0.5)'
                                ],
                                borderColor: [
                                    'rgb(54, 162, 235)',
                                    'rgb(255, 99, 132)',
                                    'rgb(75, 192, 192)',
                                    'rgb(255, 159, 64)'
                                ],
                                borderWidth: 1
                            }]
                        };
                        
                        attackChart = new Chart(chartEl, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Security Level (bits)'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Key Exchange Security Comparison'
                                    }
                                }
                            }
                        });
                        break;
                        
                    default:
                        vizEl.classList.add('hidden');
                        break;
                }
            }
            
            // Encrypt Button Handler
            document.getElementById('encryptBtn').addEventListener('click', async () => {
                const input = document.getElementById('inputText').value;
                if (!input) {
                    alert('Please enter some text to encrypt');
                    return;
                }
                
                const mode = document.getElementById('mode').value;
                currentMode = mode;
                
                const button = document.getElementById('encryptBtn');
                const originalText = button.textContent;
                button.textContent = 'Encrypting...';
                button.disabled = true;
                
                try {
                    const response = await fetch('/encrypt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: input, mode: mode })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Encryption failed');
                    }
                    
                    const result = await response.json();
                    currentCiphertext = result.ciphertext;
                    
                    document.getElementById('cipherText').textContent = result.ciphertext;
                    document.getElementById('output').classList.remove('hidden');
                    document.getElementById('processDiagram').classList.remove('hidden');
                    
                    // Animate encryption process
                    animateEncryptionProcess(mode);
                    
                    // Animate ciphertext appearance
                    anime({
                        targets: '#cipherText',
                        scale: [0, 1],
                        duration: 500,
                        easing: 'easeOutElastic(1, .5)'
                    });
                    
                } catch (error) {
                    console.error('Encryption error:', error);
                    alert('Error during encryption: ' + error.message);
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Animate the encryption process visualizer
            function animateEncryptionProcess(mode) {
                // Show/hide ZTM specific elements
                document.querySelectorAll('.ztm-only').forEach(el => {
                    if (mode === 'ztm') {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
                
                // Animation for process steps
                anime.timeline({
                    easing: 'easeOutExpo',
                    duration: 300
                })
                .add({
                    targets: '#step1',
                    scale: [0, 1],
                    rotateZ: ['-45deg', '0deg']
                })
                .add({
                    targets: '#step2',
                    scale: [0, 1],
                    rotateZ: ['-45deg', '0deg']
                }, '-=150')
                .add({
                    targets: '#step3',
                    scale: [0, 1],
                    rotateZ: ['-45deg', '0deg']
                }, '-=150')
                .add({
                    targets: '#step4',
                    scale: [0, 1],
                    rotateZ: ['-45deg', '0deg']
                }, '-=150');
                
                if (mode === 'ztm') {
                    anime({
                        targets: '#step5',
                        scale: [0, 1],
                        rotateZ: ['-45deg', '0deg'],
                        delay: 750
                    });
                }
            }
            
            // Decrypt button handler
            document.getElementById('decryptBtn').addEventListener('click', async () => {
                if (!currentCiphertext) {
                    alert('No encrypted message to decrypt');
                    return;
                }
                
                const button = document.getElementById('decryptBtn');
                const originalText = button.textContent;
                button.textContent = 'Decrypting...';
                button.disabled = true;
                
                try {
                    const response = await fetch('/decrypt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ciphertext: currentCiphertext, mode: currentMode })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Decryption failed');
                    }
                    
                    const result = await response.json();
                    document.getElementById('plainText').textContent = result.plaintext;
                    
                    // Animate plaintext appearance
                    anime({
                        targets: '#plainText',
                        scale: [0, 1],
                        duration: 500,
                        easing: 'easeOutElastic(1, .5)'
                    });
                    
                } catch (error) {
                    console.error('Decryption error:', error);
                    alert('Error during decryption: ' + error.message);
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
        });
    </script>
</body>
</html>